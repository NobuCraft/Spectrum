import asyncio
import aiohttp
import random
from telegram import Update
from telegram.ext import Application, MessageHandler, filters, ContextTypes

# ===================== –¢–û–ö–ï–ù–´ =====================
TELEGRAM_TOKEN = "8326390250:AAEpXRnhLLLi5zUeFC39nfkHDlxR5ZFQ_yQ"
HF_TOKEN = "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"

# ===================== HUGGING FACE AI =====================
class HuggingFaceAI:
    def __init__(self):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Mistral - –æ–Ω–∞ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–Ω–∏–º–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π
        self.model = "mistralai/Mistral-7B-Instruct-v0.1"
        self.api_url = f"https://api-inference.huggingface.co/models/{self.model}"
        self.headers = {"Authorization": f"Bearer {HF_TOKEN}"}
        print(f"ü§ñ Hugging Face AI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        print(f"üì° –ú–æ–¥–µ–ª—å: {self.model}")
    
    async def get_response(self, message: str) -> str:
        try:
            # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Mistral
            prompt = f"<s>[INST] –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∏–º–µ–Ω–∏ –°–ø–µ–∫—Ç—Ä. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —Å —ç–º–æ–¥–∑–∏, –ø–æ-—Ä—É—Å—Å–∫–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: {message} [/INST]"
            
            print(f"üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å...")
            
            async with aiohttp.ClientSession() as session:
                async with session.post(self.api_url, headers=self.headers, json={
                    "inputs": prompt,
                    "parameters": {
                        "max_new_tokens": 150,
                        "temperature": 0.8,
                        "top_p": 0.95,
                        "do_sample": True,
                        "repetition_penalty": 1.1
                    }
                }, timeout=30) as resp:
                    
                    if resp.status == 200:
                        result = await resp.json()
                        if isinstance(result, list) and len(result) > 0:
                            text = result[0].get("generated_text", "")
                            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ [/INST]
                            response = text.split("[/INST]")[-1].strip() if "[/INST]" in text else text.strip()
                            
                            # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π
                            if len(response) < 5:
                                return self._get_local_response(message)
                            
                            print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API")
                            return response
                        return self._get_local_response(message)
                    
                    elif resp.status == 503:
                        print("‚è≥ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...")
                        return "‚è≥ –ú–∏–Ω—É—Ç–∫—É, —è –ø—Ä–æ—Å—ã–ø–∞—é—Å—å... –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥!"
                    else:
                        print(f"‚ùå –û—à–∏–±–∫–∞ API: {resp.status}")
                        return self._get_local_response(message)
                        
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            return self._get_local_response(message)
    
    def _get_local_response(self, message: str) -> str:
        """–£–º–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±–æ–π —Å–ª—É—á–∞–π"""
        message_lower = message.lower()
        
        # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        if any(word in message_lower for word in ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "—Ö–∞–π", "hello", "–∫—É"]):
            return random.choice([
                "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞? üòä",
                "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! –†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å! üëã",
                "–•—ç–π! –ß–µ–≥–æ –Ω–æ–≤–æ–≥–æ? ‚ú®",
                "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π! üåü"
            ])
        
        # –ö–∞–∫ –¥–µ–ª–∞
        elif any(word in message_lower for word in ["–∫–∞–∫ –¥–µ–ª–∞", "–∫–∞–∫ —Ç—ã", "—á—ë –∫–∞–∫", "—á—Ç–æ –∫–∞–∫"]):
            return random.choice([
                "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ê —É —Ç–µ–±—è? üòä",
                "–°—É–ø–µ—Ä! –†–∞–±–æ—Ç–∞—é, –ø–æ–º–æ–≥–∞—é –ª—é–¥—è–º! üí™",
                "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª! üåü",
                "–ù–æ—Ä–º–∞–ª—å–Ω–æ, –∞ —É —Ç–µ–±—è –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ? ü§ó"
            ])
        
        # –ß—Ç–æ –¥–µ–ª–∞–µ—à—å
        elif any(word in message_lower for word in ["—á—Ç–æ –¥–µ–ª–∞–µ—à—å", "—á–µ–º –∑–∞–Ω—è—Ç", "—á—Ç–æ –¥–µ–ª–∞–µ—à—å"]):
            return random.choice([
                "–û–±—â–∞—é—Å—å —Å —Ç–æ–±–æ–π, —ç—Ç–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ! üí¨",
                "–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º –∏ —É—á—É—Å—å –Ω–æ–≤–æ–º—É! üß†",
                "–û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ä–∞–¥—É—é –ª—é–¥–µ–π! ‚ú®",
                "–ñ–¥—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ç–µ–±—è! ‚å®Ô∏è"
            ])
        
        # –ü–æ–∫–∞/–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è
        elif any(word in message_lower for word in ["–ø–æ–∫–∞", "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", "–ø—Ä–æ—â–∞–π", "—É–¥–∞—á–∏"]):
            return random.choice([
                "–î–æ –≤—Å—Ç—Ä–µ—á–∏! –ë—É–¥—É –∂–¥–∞—Ç—å! üëã",
                "–ü–æ–∫–∞-–ø–æ–∫–∞! –ó–∞—Ö–æ–¥–∏ –µ—â—ë! üåü",
                "–£–¥–∞—á–∏ —Ç–µ–±–µ! –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è —Å–∫–æ—Ä–µ–µ! ü§ó",
                "–°—á–∞—Å—Ç–ª–∏–≤–æ! –†–∞–¥ –±—ã–ª –ø–æ–æ–±—â–∞—Ç—å—Å—è! üí´"
            ])
        
        # –°–ø–∞—Å–∏–±–æ
        elif any(word in message_lower for word in ["—Å–ø–∞—Å–∏–±–æ", "–±–ª–∞–≥–æ–¥–∞—Ä—é", "thanks"]):
            return random.choice([
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –†–∞–¥ –ø–æ–º–æ—á—å! üòä",
                "–ù–µ –∑–∞ —á—Ç–æ! –û–±—Ä–∞—â–∞–π—Å—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è! ü§ù",
                "–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! üåü",
                "–î–ª—è –º–µ–Ω—è —ç—Ç–æ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ! üí´"
            ])
        
        # –í–æ–ø—Ä–æ—Å—ã –æ –±–æ—Ç–µ
        elif any(word in message_lower for word in ["–∫—Ç–æ —Ç—ã", "—Ç—ã –∫—Ç–æ", "—Ç–≤–æ–µ –∏–º—è"]):
            return random.choice([
                "–Ø –°–ø–µ–∫—Ç—Ä - —Ç–≤–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥—Ä—É–≥ –∏ –ø–æ–º–æ—â–Ω–∏–∫! ü§ñ",
                "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º! üåü",
                "–Ø AI –±–æ—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–º–æ—â–∏! üí´"
            ])
        
        # –í–æ–ø—Ä–æ—Å—ã –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö
        elif any(word in message_lower for word in ["—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å", "–º–æ–∂–µ—à—å", "—Ñ—É–Ω–∫—Ü–∏–∏"]):
            return random.choice([
                "–Ø –º–æ–≥—É –æ–±—â–∞—Ç—å—Å—è, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —à—É—Ç–∏—Ç—å, –¥–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –∏ –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º! üåü",
                "–†–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏–∏, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–µ—Å–µ–¥—É! üí¨",
                "–Ø —É–º–µ—é —Å–ª—É—à–∞—Ç—å –∏ –æ—Ç–≤–µ—á–∞—Ç—å! –ê –µ—â—ë —É –º–µ–Ω—è –æ—Ç–ª–∏—á–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞! üòä"
            ])
        
        # –õ—é–±–æ–≤—å/–æ—Ç–Ω–æ—à–µ–Ω–∏—è
        elif any(word in message_lower for word in ["–ª—é–±–ª—é", "–ª—é–±–æ–≤—å", "–æ—Ç–Ω–æ—à–µ–Ω–∏—è"]):
            return random.choice([
                "–õ—é–±–æ–≤—å - —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ! ‚ù§Ô∏è",
                "–í –º–∏—Ä–µ —Å—Ç–æ–ª—å–∫–æ –ª—é–±–≤–∏, –≥–ª–∞–≤–Ω–æ–µ –µ—ë –∑–∞–º–µ—á–∞—Ç—å! üíï",
                "–õ—é–±–∏ –∏ –±—É–¥—å –ª—é–±–∏–º! üåü"
            ])
        
        # –ü–æ–≥–æ–¥–∞
        elif any(word in message_lower for word in ["–ø–æ–≥–æ–¥–∞", "–¥–æ–∂–¥—å", "—Å–æ–ª–Ω—Ü–µ", "—Ç–µ–ø–ª–æ"]):
            return random.choice([
                "–ü–æ–≥–æ–¥–∞ –æ—Ç–ª–∏—á–Ω–∞—è –¥–ª—è –æ–±—â–µ–Ω–∏—è! –ê —Ç–∞–º –∫–∞–∫ –∑–Ω–∞–µ—à—å üòâ",
                "–Ø –Ω–µ –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥, –Ω–æ –º–æ–≥—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ —á—ë–º —É–≥–æ–¥–Ω–æ! üå§Ô∏è",
                "–ì–ª–∞–≤–Ω–æ–µ, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±—ã–ª–æ —Å–æ–ª–Ω–µ—á–Ω–æ–µ! ‚òÄÔ∏è"
            ])
        
        # –ï–¥–∞
        elif any(word in message_lower for word in ["–µ–¥–∞", "–∫—É—à–∞—Ç—å", "–≤–∫—É—Å–Ω–æ", "–≥–æ–ª–æ–¥–µ–Ω"]):
            return random.choice([
                "–Ø –ø–∏—Ç–∞—é—Å—å —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ–º! –ê —Ç—ã —á—Ç–æ –ª—é–±–∏—à—å? ‚ö°",
                "–ü–∏—Ü—Ü–∞ - –ª—É—á—à–∏–π –≤—ã–±–æ—Ä! üçï",
                "–ú–º–º, –≤–∫—É—Å–Ω–æ! –ê —è –≤–æ—Ç –∫–æ–¥–æ–º –ø–∏—Ç–∞—é—Å—å! üíª"
            ])
        
        # –†–∞–±–æ—Ç–∞/—É—á–µ–±–∞
        elif any(word in message_lower for word in ["—Ä–∞–±–æ—Ç–∞", "—É—á–µ–±–∞", "—É—á–∏—Ç—å—Å—è", "—Ä–∞–±–æ—Ç–∞—Ç—å"]):
            return random.choice([
                "–†–∞–±–æ—Ç–∞—Ç—å –Ω—É–∂–Ω–æ –≤ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ! üí™",
                "–ì–ª–∞–≤–Ω–æ–µ - –Ω–µ –ø–µ—Ä–µ–≥–æ—Ä–µ—Ç—å! –û—Ç–¥—ã—Ö–∞–π —Ç–æ–∂–µ! ‚ú®",
                "–£—á—ë–±–∞ - —Å–≤–µ—Ç, –∞ –Ω–µ—É—á—ë–Ω—ã—Ö - —Ç—å–º–∞! üåü"
            ])
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ - –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        return random.choice([
            "–û–≥–æ, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ! üòä",
            "–ü–æ–Ω—è–ª —Ç–µ–±—è. –ê —á—Ç–æ –µ—â—ë? ü§î",
            "–•–º, –∑–∞–±–∞–≤–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π! ‚ú®",
            "–Ø —Ç–µ–±—è —Å–ª—É—à–∞—é –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ! üëÇ",
            "–î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ–± —ç—Ç–æ–º! üí¨",
            "–ö—Ä—É—Ç–æ! –ê —è –≤–æ—Ç –¥—É–º–∞—é –æ –∂–∏–∑–Ω–∏... ü§ñ",
            "–ó–∞–Ω—è—Ç–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏-–∫–∞ –ø–æ–¥—Ä–æ–±–Ω–µ–µ! üåü",
            "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ö–æ–¥ —Ç–≤–æ–∏—Ö –º—ã—Å–ª–µ–π! üí´",
            "–°–æ–≥–ª–∞—Å–µ–Ω —Å —Ç–æ–±–æ–π –Ω–∞ –≤—Å–µ 100! üëç",
            "–•–æ—Ä–æ—à–∞—è –º—ã—Å–ª—å, —è –∑–∞–ø–æ–º–Ω—é! üß†",
            "–¢—ã —Å–µ–≥–æ–¥–Ω—è –≤ —É–¥–∞—Ä–µ! ‚ö°",
            "–ú—É–¥—Ä—ã–µ —Å–ª–æ–≤–∞! üìù",
            "–û, —ç—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–µ–º–∞! ‚ú®",
            "–†–∞—Å—Å–∫–∞–∂–∏-–∫–∞ –ø–æ–¥—Ä–æ–±–Ω–µ–µ! üí¨",
            "–Ø –≤–µ—Å—å –≤–æ –≤–Ω–∏–º–∞–Ω–∏–∏! üëÄ",
            "–ü—Ä–æ–¥–æ–ª–∂–∞–π, —è —Å–ª—É—à–∞—é! üéß",
            "–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –ê –¥–∞–ª—å—à–µ? ü§ó"
        ])

# ===================== –°–û–ó–î–ê–ï–ú AI =====================
ai = HuggingFaceAI()

# ===================== –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô =====================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    message = update.message.text
    
    print(f"üì® –ü–æ–ª—É—á–µ–Ω–æ –æ—Ç {user.first_name}: {message}")
    
    await update.message.chat.send_action(action="typing")
    response = await ai.get_response(message)
    await update.message.reply_text(f"ü§ñ **–°–ø–µ–∫—Ç—Ä:** {response}")
    print(f"üì§ –û—Ç–≤–µ—Ç: {response}")

# ===================== –ö–û–ú–ê–ù–î–ê –°–¢–ê–†–¢ =====================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üöÄ **–°–ø–µ–∫—Ç—Ä AI –∑–∞–ø—É—â–µ–Ω!**\n\n"
        "–Ø - —Ç–≤–æ–π —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –Ω–∞—Å—Ç–æ—è—â–∏–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º!\n\n"
        "**–ß—Ç–æ —è —É–º–µ—é:**\n"
        "‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n"
        "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–µ—Å–µ–¥—É\n"
        "‚Ä¢ –®—É—Ç–∏—Ç—å –∏ –¥–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã\n"
        "‚Ä¢ –ü–æ–Ω–∏–º–∞—Ç—å —ç–º–æ—Ü–∏–∏\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å! üí¨"
    )

# ===================== –ó–ê–ü–£–°–ö =====================
async def main():
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞...")
    
    app = Application.builder().token(TELEGRAM_TOKEN).build()
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    await app.initialize()
    await app.start()
    await app.updater.start_polling()
    
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –û—Ç–ø—Ä–∞–≤—å –µ–º—É –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!")
    print("üì° –ò—Å–ø–æ–ª—å–∑—É–µ–º Hugging Face API...")
    
    while True:
        await asyncio.sleep(1)

if __name__ == "__main__":
    asyncio.run(main())
